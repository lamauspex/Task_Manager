<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашборд задач</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .chart-container:hover {
            transform: translateY(-5px);
        }
        .user-card {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
        }
        .main-chart {
            height: 400px;
        }
        .side-panel {
            height: 400px;
        }
    </style>
</head>
<body>
    <!-- Шапка дашборда -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line me-3"></i>Дашборд задач</h1>
                    <p class="lead">Обзор статистики и производительности команды</p>
                </div>
                <div class="col-md-4 text-end">
                    <span id="current-date"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Карточки с общей статистикой -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <i class="fas fa-tasks fa-2x mb-3 text-primary"></i>
                    <h4>Всего задач</h4>
                    <div class="stat-number" id="total-tasks">0</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <i class="fas fa-user-check fa-2x mb-3 text-success"></i>
                    <h4>Активные сотрудники</h4>
                    <div class="stat-number" id="active-users">0</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <i class="fas fa-user-clock fa-2x mb-3 text-warning"></i>
                    <h4>Назначенные задачи</h4>
                    <div class="stat-number" id="assigned-tasks">0</div>
                </div>
            </div>
        </div>

        <!-- Первый ряд: Назначенные задачи + Боковая панель -->
        <div class="row mb-4">
            <!-- Основной график - Назначенные задачи -->
            <div class="col-lg-8">
                <div class="chart-container main-chart">
                    <h4><i class="fas fa-list-alt me-2"></i>Назначенные задачи сотрудникам</h4>
                    {{ bar_activ|safe }}
                </div>
            </div>

            <!-- Боковая панель -->
            <div class="col-lg-4">
                <!-- Список пользователей -->
                <div class="chart-container side-panel">
                    <h4><i class="fas fa-users me-2"></i>Команда</h4>
                    <div id="users-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- Список пользователей будет загружен здесь -->
                    </div>
                </div>

                <!-- Быстрые действия -->
                <div class="chart-container">
                    <h4><i class="fas fa-info-circle me-2"></i>Быстрые действия</h4>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="refreshCharts()">
                            <i class="fas fa-sync-alt me-2"></i>Обновить данные
                        </button>
                        <button class="btn btn-outline-secondary" onclick="exportData()">
                            <i class="fas fa-download me-2"></i>Экспорт отчёта
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Второй ряд: Два графика в одну линию -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h4><i class="fas fa-chart-pie me-2"></i>Статусы задач</h4>
                    {{ pie_chart|safe }}
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h4><i class="fas fa-trophy me-2"></i>Выполненные задачи</h4>
                    {{ bar_chart|safe }}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Установка текущей даты
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('ru-RU', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Функции для взаимодействия
        function refreshCharts() {
            location.reload();
        }

        function exportData() {
            alert('Функция экспорта будет реализована позже');
        }

        // Загрузка списка пользователей
        fetch('/users/dashboard/list')
            .then(response => response.json())
            .then(users => {
                const usersList = document.getElementById('users-list');
                users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card';
                    userCard.innerHTML = `
                        <h6 class="mb-2">${user.full_name}</h6>
                        <small><i class="fas fa-envelope me-1"></i>${user.email}</small>
                    `;
                    usersList.appendChild(userCard);
                });

                // Обновляем статистику
                document.getElementById('active-users').textContent = users.length;
            })
            .catch(error => console.error('Ошибка загрузки пользователей:', error));

        // Обновление статистики из данных шаблона
        document.addEventListener('DOMContentLoaded', function() {
            const totalTasks = {{ total_tasks }};
            const assignedTasks = {{ assigned_tasks }};
            const activeUsersCount = {{ active_users_count }};

            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('assigned-tasks').textContent = assignedTasks;
            document.getElementById('active-users').textContent = activeUsersCount;
        });
    </script>
</body>
</html>